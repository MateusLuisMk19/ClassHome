@model DInnerViewModel
@inject ClassHomedbContext _context
@inject UserManager<UserModel> _userManager
@{
    DisciplinaModel DisRel = ViewBag.DisciplinaId;
    IEnumerable<Publicacao> PUB = ViewBag.Publicacoes;

    var usuarioLog = await _userManager.GetUserAsync(Context.User);

    var publicador = new UserModel();
    var comentador = new UserModel();
    IEnumerable<Comentario> comentarioPub;
    int count = 0;
    var RowsTxt = 0;
}

<ul class="nav nav-tabs justify-content-center position-absolute align-content-center link-info">
    <li class="nav-item">
        <a class="nav-link active">Principal</a>
    </li>
    <li class="nav-item">
        <a class="nav-link">Trabalhos</a>
    </li>
    <li class="nav-item">
        <a asp-action="Utilizadores" asp-route-disciplinaId="@DisRel.DisciplinaId" class="nav-link">Utilizadores</a>
    </li>
</ul>

<div class="bg-black  w-100 h-25 border-3 p-5 rounded-top" style="border-radius: 3%;">
    <h2 class="pt-5 pb-3">@DisRel.Nome</h2>
</div>

<partial name="_MensagemPartial"></partial>

<div class="container mt-3 ">
    <div class="row">
        
        <div class="col-3">
            <div class="card text-black bg-white">
                <div class="card-header pt-3">
                    <div class="float-start">
                        <h5 class="text-black namePub">Trabalhos</h5></div>
                    <div class="float-end ">
                    
                    </div>
                </div>
                <div class="card-body">
                    
                    <p class="card-text" title="Descrição da Disciplina"></p>
                </div>
            </div>
            <a asp-controller="Turma" asp-action="Index" asp-route-id="@DisRel.TurmaId" class="btn btn-primary mt-2 link-white">
                Voltar à Turmas
            </a>
        </div>
        
        <div class="col row">
            <div class="">
                <form asp-action="Publicar" asp-route-type="1">
                    <div class="col-11 float-start">
                        <input type="hidden" asp-for="@Model.PublicacaoId">

                        <textarea asp-for="@Model.PublicacaoTexto" class="form-control" placeholder="Nova publicação">
                        </textarea>
                        <span asp-validation-for="@Model.PublicacaoTexto" class="text-danger"></span>

                        <div class="form-group col-3 visually-hidden">
                            <label asp-for="@Model.UserId">Publicador Id</label><br>
                            <input asp-for="@Model.UserId" value="@usuarioLog.Id" class="form-control col-lg-">
                            <span asp-validation-for="@Model.UserId" class="text-danger"></span><br>
                        
                            <label asp-for="@Model.DisciplinaId">DisciplinaId Id</label><br>
                            <input asp-for="@Model.DisciplinaId" value="@DisRel.DisciplinaId" class="form-control col-lg-">
                            <span asp-validation-for="@Model.DisciplinaId" class="text-danger"></span><br>
                        </div>
                    </div>
                    <div class="col mt-0 m-0 float-end">
                        <button class="btn btn-outline-dark" style="border-radius: 20%;" type="submit">Enviar</button>
                    </div>
                </form>
            </div>
            
            <div class="w-100"></div>
            <hr class="mt-3 text-black">
            <div class="w-100"></div>
            <div class="mt-1">

        @if (PUB.Count() > 0)
        {
            @foreach (var publicacao in PUB)
            { 
                publicador = _context.Users.FirstOrDefault(x => x.Id == publicacao.UserId);
                comentarioPub = _context.Comentarios.Where(c => c.PublicacaoId == publicacao.PublicacaoId).OrderByDescending(x => x.DataComentario);
                
                <div class="card text-black bg-white mb-3">
                    
                    <div class=" mt-0 mb-1 m-3 pt-3 pb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="42" height="43" fill="currentColor" 
                            class="bi bi-person-circle float-start mt-0 mb-0 m-2" viewBox="0 0 16 16">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                        </svg>
                        <div class="float-start">

                            <h5 class="text-black namePub">@publicador.NomeCompleto</h5>
                            <h6 class="text-secondary time">@publicacao.DataPublicacao.ToLongDateString()</h6>
                        </div>
                        <div class="float-end ">
                            <a asp-action="Publicar" asp-route-id="@publicacao.PublicacaoId" asp-route-type="1" 
                                class="editar link-secondary" title="Editar Publicação" >
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a asp-action="Excluir" asp-route-type="1" asp-route-id="@publicacao.PublicacaoId" 
                                class="apagar link-danger" title="Excluir Publicação">
                                <i class="bi bi-trash" style="margin-right: 0; margin-left: 0.5vw;"></i>
                            </a>
                        </div>
                    </div>

                    <hr class="mb-0 mt-0">

                    @{
                        RowsTxt = @publicacao.Texto.NRows();
                    }
                    <textarea id="post" rows="@RowsTxt" aria-disabled="true" disabled aria-controls="false" class="bg-white card-text m-3 text-black texto border-0">@publicacao.Texto</textarea>
                    <hr class="mb-0 mt-0">
                    
                    <div class="card-body mt-0">

                        <div class="container p-2">
                            
                            <form asp-action="Publicar" asp-route-type="2">
                                 <div class="row">
                                    <input type="hidden" asp-for="@Model.ComentarioId">
                                        
                                    <div class="form-group col-3 visually-hidden">
                                        <label asp-for="@Model.UserId">Comentador Id</label><br>
                                        <input asp-for="@Model.UserId" value="@usuarioLog.Id" class="form-control col-lg-">
                                        <span asp-validation-for="@Model.UserId" class="text-danger"></span><br>
                                        
                                        <label asp-for="@Model.PublicacaoId">Comentador Id</label><br>
                                        <input asp-for="@Model.PublicacaoId" value="@publicacao.PublicacaoId" class="form-control col-lg-">
                                        <span asp-validation-for="@Model.PublicacaoId" class="text-danger"></span><br>

                                        <label asp-for="@Model.DisciplinaId">DisciplinaId Id</label><br>
                                        <input asp-for="@Model.DisciplinaId" value="@DisRel.DisciplinaId" class="form-control col-lg-">
                                        <span asp-validation-for="@Model.DisciplinaId" class="text-danger"></span><br>
                                    </div>

                                    <div class="input-group mb-2 mr-sm-2">
                                        <input asp-for="@Model.ComentarioTexto" class="form-control border col m-0" placeholder="Deixe o seu comentario">
                                        <span asp-validation-for="@Model.ComentarioTexto" class="text-danger"></span>
                                        <div class="input-group-prepend ">
                                            <div class="input-group-text bg-transparent">
                                                <button class="rounded-circle float-end m-0 btcom border-1" type="submit">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="25" fill="currentColor" 
                                                    class="bi bi-arrow-right-short" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z"/>
                                                </svg>
                                            </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </form>

                        </div>

                        @if (comentarioPub.Count() > 0)
                        {   
                            count=0;

                            <div class="card mt-1 bg-secondary bg-opacity-10 p-2 pt-3 pb-0">
                            
                                @foreach (var com in comentarioPub)
                                { 
                                    comentador = _context.Users.FirstOrDefault(x => x.Id == com.UserId);

                                    @if(count >= 1)
                                    {
                                        <hr class="m-0 mb-3">
                                    }

                                    <div>
                                        <div class="float-start">
                                            <h6 class="text-black m-3 mt-0 mb-0">@comentador.NomeCompleto</h6>
                                        </div>
                                        
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"  
                                        fill="currentColor" class="bi bi-caret-left-fill float-end m-0 mt-0 mb-0" viewBox="0 0 16 16">
                                            <path d="m3.86 8.753 5.482 4.796c.646.566 1.658.106 1.658-.753V3.204a1 1 0 0 0-1.659-.753l-5.48 4.796a1 1 0 0 0 0 1.506z"/>
                                        </svg>

                                        <div class="float-end m-1 mt-0 mb-0">
                                            <div class="bg-secondary bg-opacity-10" id="OPC">
                                                <a asp-action="Publicar" asp-route-id="@com.ComentarioId" asp-route-type="2" 
                                                    class="editar link-secondary" title="Editar Comentário" >
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <a asp-action="Excluir" asp-route-id="@com.ComentarioId" asp-route-type="2"
                                                    class="apagar link-danger" title="Excluir Comentário">
                                                    <i class="bi bi-trash" style="margin-right: 0; margin-left: 0.5vw;"></i>
                                                </a>
                                            </div>
                                            
                                            <h6 class="text-secondary " id="TMC">@com.DataComentario.ToShortDateString()</h6>
                                        </div>
                                    </div>
                                    <p class="textoc mb-2 m-4 mt-0">@com.Texto</p>
                                    
                                    count++;
                                }
                            </div>
                        }                        
                    </div>
                </div>                  
           }
        } 

            </div>
        </div>
    </div>
</div>
<style>
    .namePub{
        font-size: 110%;
    }

    .time{
        font-size: 80%;
        margin-top: 0px;
        opacity: 0.5;
    }

    .btcom:hover{
        background-color: #CCC;
        box-shadow: 2px 1px 1px #DDD;
        color: white;
    }

    .texto{
        font-size: 110%;
        resize: none;
    }
</style> 
